# VALENTINE RF - Signal Intelligence Platform
# Docker Compose configuration for easy deployment
#
# Security: privileged mode replaced with targeted Linux capabilities.
# The container runs as non-root (USER valentine in Dockerfile).
#
# Basic usage (build locally):
#   docker compose --profile basic up -d --build
#
# Basic usage (pre-built image from registry):
#   VALENTINE_IMAGE=ghcr.io/user/valentine-rf:latest docker compose --profile basic up -d
#
# With ADS-B history (Postgres):
#   docker compose --profile history up -d

services:
  valentine-rf:
    # When VALENTINE_IMAGE is set, use that pre-built image; otherwise build locally
    image: ${VALENTINE_IMAGE:-valentine-rf:latest}
    build: .
    container_name: valentine-rf
    ports:
      - "5050:5050"
    # Targeted capabilities instead of privileged: true
    # SYS_RAWIO  — USB SDR device I/O
    # NET_ADMIN  — WiFi monitor mode (aircrack-ng, iw)
    # NET_RAW    — Raw sockets for BLE/WiFi scanning (scapy, hcxdumptool)
    cap_add:
      - SYS_RAWIO
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - no-new-privileges:true
    # USB device mapping for SDR dongles
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      # Persist decoded images and database across container rebuilds
      - ./data:/app/data
      # Optional: mount logs directory
      # - ./logs:/app/logs
    environment:
      - VALENTINE_HOST=0.0.0.0
      - VALENTINE_PORT=5050
      - VALENTINE_LOG_LEVEL=INFO
      # SECURITY: Set these in production!
      # - VALENTINE_SECRET_KEY=<random-64-char-hex>
      # - VALENTINE_ADMIN_PASSWORD=<strong-password>
      # ADS-B history is disabled by default
      # To enable, use: docker compose --profile history up -d
      # - VALENTINE_ADSB_HISTORY_ENABLED=true
      # - VALENTINE_ADSB_DB_HOST=adsb_db
      # - VALENTINE_ADSB_DB_PORT=5432
      # - VALENTINE_ADSB_DB_NAME=valentine_adsb
      # - VALENTINE_ADSB_DB_USER=valentine
      # - VALENTINE_ADSB_DB_PASSWORD=valentine
      # ADS-B auto-start on dashboard load (default false)
      - VALENTINE_ADSB_AUTO_START=${VALENTINE_ADSB_AUTO_START:-false}
      # Shared observer location across modules
      - VALENTINE_SHARED_OBSERVER_LOCATION=${VALENTINE_SHARED_OBSERVER_LOCATION:-true}
      # Default observer coordinates (set to your location to skip the GPS prompt)
      # - VALENTINE_DEFAULT_LAT=${VALENTINE_DEFAULT_LAT:-0}
      # - VALENTINE_DEFAULT_LON=${VALENTINE_DEFAULT_LON:-0}
    # Network mode for WiFi scanning (requires host network)
    # network_mode: host
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:5050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ADS-B history with Postgres persistence
  # Enable with: docker compose --profile history up -d
  valentine-rf-history:
    # Same image/build fallback pattern as above
    image: ${VALENTINE_IMAGE:-valentine-rf:latest}
    build: .
    container_name: valentine-rf-history
    profiles:
      - history
    depends_on:
      - adsb_db
    ports:
      - "5050:5050"
    # Targeted capabilities instead of privileged: true
    cap_add:
      - SYS_RAWIO
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - no-new-privileges:true
    # USB device mapping for SDR dongles
    devices:
      - /dev/bus/usb:/dev/bus/usb
    volumes:
      - ./data:/app/data
    environment:
      - VALENTINE_HOST=0.0.0.0
      - VALENTINE_PORT=5050
      - VALENTINE_LOG_LEVEL=INFO
      # SECURITY: Set these in production!
      # - VALENTINE_SECRET_KEY=<random-64-char-hex>
      # - VALENTINE_ADMIN_PASSWORD=<strong-password>
      - VALENTINE_ADSB_HISTORY_ENABLED=true
      - VALENTINE_ADSB_DB_HOST=adsb_db
      - VALENTINE_ADSB_DB_PORT=5432
      - VALENTINE_ADSB_DB_NAME=valentine_adsb
      - VALENTINE_ADSB_DB_USER=valentine
      - VALENTINE_ADSB_DB_PASSWORD=valentine
      # ADS-B auto-start on dashboard load (default false)
      - VALENTINE_ADSB_AUTO_START=${VALENTINE_ADSB_AUTO_START:-false}
      # Shared observer location across modules
      - VALENTINE_SHARED_OBSERVER_LOCATION=${VALENTINE_SHARED_OBSERVER_LOCATION:-true}
      # Default observer coordinates (set to your location to skip the GPS prompt)
      # - VALENTINE_DEFAULT_LAT=${VALENTINE_DEFAULT_LAT:-0}
      # - VALENTINE_DEFAULT_LON=${VALENTINE_DEFAULT_LON:-0}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:5050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  adsb_db:
    image: postgres:16-alpine
    container_name: valentine-adsb-db
    profiles:
      - history
    environment:
      - POSTGRES_DB=valentine_adsb
      - POSTGRES_USER=valentine
      - POSTGRES_PASSWORD=valentine
    volumes:
      # Default local path (override with PGDATA_PATH for external storage)
      - ${PGDATA_PATH:-./pgdata}:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U valentine -d valentine_adsb"]
      interval: 10s
      timeout: 5s
      retries: 5

# Optional: Add volume for persistent SQLite database
# volumes:
#   valentine-data:
