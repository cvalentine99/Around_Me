<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYSTEM STATUS // VALENTINE RF</title>
    {% if offline_settings.fonts_source == 'local' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fonts-local.css') }}">
    {% else %}
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    {% endif %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/core/variables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/responsive.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global-nav.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/settings.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/help-modal.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/system_status.css') }}">
    <script src="{{ url_for('static', filename='js/core/observer-location.js') }}"></script>
</head>
<body>
    <div class="grid-bg"></div>
    <div class="scanline"></div>

    <!-- ============================
         HEADER
         ============================ -->
    <header class="header">
        <div class="logo">
            SYSTEM STATUS
            <span>// VALENTINE RF - Configuration &amp; Diagnostics</span>
        </div>
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot active" id="sysStatusDot"></div>
                <span id="sysStatusLabel">ONLINE</span>
            </div>
            <div class="datetime" id="utcTime">--:--:-- UTC</div>
        </div>
    </header>

    <!-- ============================
         NAVIGATION
         ============================ -->
    {% set active_mode = 'system_status' %}
    {% include 'partials/nav.html' with context %}

    <!-- ============================
         MAIN DASHBOARD
         ============================ -->
    <main class="ss-dashboard">

        <!-- ===== SECTION 1: OFFLINE MODE ===== -->
        <section class="ss-panel">
            <div class="ss-panel-header">
                <span class="ss-panel-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-icon"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                    OFFLINE MODE <span class="accent">// LOCAL ASSETS</span>
                </span>
            </div>
            <div class="ss-panel-body">
                <div class="ss-setting-row">
                    <div class="ss-setting-label">
                        <span class="ss-label-text">Enable Offline Mode</span>
                        <span class="ss-label-desc">Use local assets instead of CDN</span>
                    </div>
                    <label class="ss-toggle">
                        <input type="checkbox" id="ssOfflineEnabled" onchange="SystemStatus.toggleOfflineMode(this.checked)">
                        <span class="ss-toggle-slider"></span>
                    </label>
                </div>

                <div class="ss-setting-row">
                    <div class="ss-setting-label">
                        <span class="ss-label-text">JavaScript/CSS Libraries</span>
                        <span class="ss-label-desc">Leaflet, Chart.js source</span>
                    </div>
                    <select id="ssAssetsSource" class="ss-select" onchange="SystemStatus.saveSetting('offline.assets_source', this.value)">
                        <option value="cdn">CDN (Online)</option>
                        <option value="local">Local</option>
                    </select>
                </div>

                <div class="ss-setting-row">
                    <div class="ss-setting-label">
                        <span class="ss-label-text">Web Fonts</span>
                        <span class="ss-label-desc">Font loading source</span>
                    </div>
                    <select id="ssFontsSource" class="ss-select" onchange="SystemStatus.saveSetting('offline.fonts_source', this.value)">
                        <option value="cdn">Google Fonts (Online)</option>
                        <option value="local">Local</option>
                    </select>
                </div>

                <div class="ss-setting-row">
                    <div class="ss-setting-label">
                        <span class="ss-label-text">Tile Provider</span>
                        <span class="ss-label-desc">Map background imagery</span>
                    </div>
                    <select id="ssTileProvider" class="ss-select" onchange="SystemStatus.saveSetting('offline.tile_provider', this.value)">
                        <option value="openstreetmap">OpenStreetMap</option>
                        <option value="cartodb_dark">CartoDB Dark</option>
                        <option value="cartodb_dark_cyan">CartoDB Dark (Cyan Tint)</option>
                        <option value="cartodb_light">CartoDB Positron</option>
                        <option value="esri_world">ESRI World Imagery</option>
                        <option value="custom">Custom URL</option>
                    </select>
                </div>

                <div class="ss-divider"></div>

                <div class="ss-subsection-title">Local Asset Status</div>
                <div class="ss-asset-grid">
                    <div class="ss-asset-item">
                        <span class="ss-asset-name">Leaflet JS/CSS</span>
                        <span class="ss-asset-badge checking" id="ssStatusLeaflet">Checking...</span>
                    </div>
                    <div class="ss-asset-item">
                        <span class="ss-asset-name">Chart.js</span>
                        <span class="ss-asset-badge checking" id="ssStatusChartjs">Checking...</span>
                    </div>
                    <div class="ss-asset-item">
                        <span class="ss-asset-name">Inter Font</span>
                        <span class="ss-asset-badge checking" id="ssStatusInter">Checking...</span>
                    </div>
                    <div class="ss-asset-item">
                        <span class="ss-asset-name">JetBrains Mono</span>
                        <span class="ss-asset-badge checking" id="ssStatusJetbrains">Checking...</span>
                    </div>
                </div>

                <button class="ss-btn" onclick="SystemStatus.checkAssets()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-btn-icon"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                    Check Assets
                </button>

                <div class="ss-info-note">
                    Changes to asset sources require a page reload. Local assets must be in <code>/static/vendor/</code>.
                </div>
            </div>
        </section>

        <!-- ===== SECTION 2: WEBSDR RECEIVERS ===== -->
        <section class="ss-panel wide">
            <div class="ss-panel-header">
                <span class="ss-panel-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-icon"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
                    WEBSDR RECEIVERS <span class="accent">// KIWISDR NETWORK</span>
                </span>
                <div class="ss-panel-actions">
                    <input type="text" id="ssReceiverFilter" class="ss-input-sm" placeholder="Filter by frequency (kHz)..." oninput="SystemStatus.filterReceivers(this.value)">
                    <button class="ss-btn ss-btn-sm" onclick="SystemStatus.findNearest()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-btn-icon"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg>
                        Find Nearest
                    </button>
                </div>
            </div>
            <div class="ss-panel-body">
                <div class="ss-table-wrap">
                    <table class="ss-table" id="ssReceiversTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Frequency Range</th>
                                <th>Users</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ssReceiversBody">
                            <tr><td colspan="5" class="ss-loading">Loading receivers...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="ss-receiver-count" id="ssReceiverCount"></div>
            </div>
        </section>

        <!-- ===== SECTION 3: SYSTEM UPDATES ===== -->
        <section class="ss-panel">
            <div class="ss-panel-header">
                <span class="ss-panel-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-icon"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    SYSTEM UPDATES <span class="accent">// VERSION CONTROL</span>
                </span>
            </div>
            <div class="ss-panel-body">
                <div class="ss-version-block">
                    <div class="ss-version-row">
                        <span class="ss-version-label">Current Version</span>
                        <span class="ss-version-value" id="ssCurrentVersion">{{ version }}</span>
                    </div>
                    <div class="ss-version-row">
                        <span class="ss-version-label">Latest Version</span>
                        <span class="ss-version-value" id="ssLatestVersion">--</span>
                    </div>
                    <div class="ss-version-row">
                        <span class="ss-version-label">Status</span>
                        <span class="ss-update-badge" id="ssUpdateBadge">Checking...</span>
                    </div>
                </div>

                <div class="ss-update-progress" id="ssUpdateProgress" style="display: none;">
                    <div class="ss-progress-bar">
                        <div class="ss-progress-fill" id="ssProgressFill"></div>
                    </div>
                    <span class="ss-progress-text" id="ssProgressText">Updating...</span>
                </div>

                <div class="ss-update-result" id="ssUpdateResult" style="display: none;"></div>

                <div class="ss-btn-group">
                    <button class="ss-btn" onclick="SystemStatus.checkUpdates()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-btn-icon"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        Check Now
                    </button>
                    <button class="ss-btn ss-btn-primary" id="ssUpdateBtn" onclick="SystemStatus.performUpdate()" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-btn-icon"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Update
                    </button>
                    <button class="ss-btn ss-btn-danger" id="ssRestartBtn" onclick="SystemStatus.restartApp()" style="display: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-btn-icon"><path d="M18.36 6.64A9 9 0 1 1 12 3"/><polyline points="12 3 12 9 18 9"/></svg>
                        Restart
                    </button>
                </div>
            </div>
        </section>

        <!-- ===== SECTION 4: SYSTEM INFO ===== -->
        <section class="ss-panel">
            <div class="ss-panel-header">
                <span class="ss-panel-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ss-icon"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                    SYSTEM INFO <span class="accent">// DIAGNOSTICS</span>
                </span>
            </div>
            <div class="ss-panel-body">
                <div class="ss-info-grid">
                    <div class="ss-info-cell">
                        <div class="ss-info-value" id="ssUptime">--</div>
                        <div class="ss-info-label">UPTIME</div>
                    </div>
                    <div class="ss-info-cell">
                        <div class="ss-info-value" id="ssVersion">{{ version }}</div>
                        <div class="ss-info-label">VERSION</div>
                    </div>
                    <div class="ss-info-cell">
                        <div class="ss-info-value" id="ssWebSDRStatus">--</div>
                        <div class="ss-info-label">WEBSDR</div>
                    </div>
                    <div class="ss-info-cell">
                        <div class="ss-info-value" id="ssReceiverTotal">--</div>
                        <div class="ss-info-label">RECEIVERS</div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- ============================
         FOOTER
         ============================ -->
    <footer class="ss-footer">
        <span id="ssLastRefresh">LAST REFRESH: --</span>
        <button class="ss-btn ss-btn-sm" onclick="SystemStatus.refreshAll()">REFRESH ALL</button>
    </footer>

    <!-- ============================
         MODALS
         ============================ -->
    {% include 'partials/settings-modal.html' %}
    {% include 'partials/help-modal.html' %}

    <!-- ============================
         SCRIPTS
         ============================ -->
    <script src="{{ url_for('static', filename='js/core/settings-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/updater.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/alerts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/recordings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/core/global-nav.js') }}"></script>

    <script>
    /* =============================================
       SYSTEM STATUS - Inline Controller
       ============================================= */

    const SystemStatus = {
        _receivers: [],
        _filteredReceivers: [],
        _startTime: Date.now(),

        // ------------------------------------------
        // Initialization
        // ------------------------------------------
        init() {
            this.loadOfflineSettings();
            this.checkAssets();
            this.loadReceivers();
            this.checkUpdates();
            this.loadWebSDRStatus();
            this.startUptimeCounter();
            this.updateLastRefresh();
        },

        // ------------------------------------------
        // Offline Mode
        // ------------------------------------------
        async loadOfflineSettings() {
            try {
                const resp = await fetch('/offline/settings');
                if (!resp.ok) return;
                const data = await resp.json();
                const s = data.settings || {};

                const offlineEl = document.getElementById('ssOfflineEnabled');
                if (offlineEl) offlineEl.checked = !!s['offline.enabled'];

                const assetsEl = document.getElementById('ssAssetsSource');
                if (assetsEl) assetsEl.value = s['offline.assets_source'] || 'cdn';

                const fontsEl = document.getElementById('ssFontsSource');
                if (fontsEl) fontsEl.value = s['offline.fonts_source'] || 'cdn';

                const tileEl = document.getElementById('ssTileProvider');
                if (tileEl) tileEl.value = s['offline.tile_provider'] || 'cartodb_dark_cyan';
            } catch (e) {
                console.warn('Failed to load offline settings:', e);
            }
        },

        async toggleOfflineMode(enabled) {
            await this.saveSetting('offline.enabled', enabled);
            if (enabled) {
                await this.saveSetting('offline.assets_source', 'local');
                await this.saveSetting('offline.fonts_source', 'local');
                const assetsEl = document.getElementById('ssAssetsSource');
                if (assetsEl) assetsEl.value = 'local';
                const fontsEl = document.getElementById('ssFontsSource');
                if (fontsEl) fontsEl.value = 'local';
            }
            this._showReloadPrompt();
        },

        async saveSetting(key, value) {
            try {
                await fetch('/offline/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, value })
                });
            } catch (e) {
                console.warn('Failed to save setting:', e);
            }
        },

        async checkAssets() {
            const assets = {
                leaflet: ['/static/vendor/leaflet/leaflet.js', '/static/vendor/leaflet/leaflet.css'],
                chartjs: ['/static/vendor/chartjs/chart.umd.min.js'],
                inter: ['/static/vendor/fonts/Inter-Regular.woff2'],
                jetbrains: ['/static/vendor/fonts/JetBrainsMono-Regular.woff2']
            };

            for (const [name, urls] of Object.entries(assets)) {
                const capName = name.charAt(0).toUpperCase() + name.slice(1);
                const el = document.getElementById('ssStatus' + capName);
                if (el) {
                    el.textContent = 'Checking...';
                    el.className = 'ss-asset-badge checking';
                }

                let available = true;
                for (const url of urls) {
                    try {
                        const resp = await fetch(url, { method: 'HEAD' });
                        if (!resp.ok) { available = false; break; }
                    } catch (e) { available = false; break; }
                }

                if (el) {
                    el.textContent = available ? 'Available' : 'Missing';
                    el.className = 'ss-asset-badge ' + (available ? 'available' : 'missing');
                }
            }
        },

        // ------------------------------------------
        // WebSDR Receivers
        // ------------------------------------------
        async loadReceivers() {
            const tbody = document.getElementById('ssReceiversBody');
            const totalEl = document.getElementById('ssReceiverTotal');

            try {
                const resp = await fetch('/websdr/receivers');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                this._receivers = data.receivers || [];
                this._filteredReceivers = [...this._receivers];

                if (totalEl) totalEl.textContent = this._receivers.length;
                this.renderReceivers();
            } catch (e) {
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="5" class="ss-loading ss-error">Failed to load receivers</td></tr>';
                }
                if (totalEl) totalEl.textContent = '0';
                console.warn('Failed to load WebSDR receivers:', e);
            }
        },

        renderReceivers() {
            const tbody = document.getElementById('ssReceiversBody');
            const countEl = document.getElementById('ssReceiverCount');
            if (!tbody) return;

            const list = this._filteredReceivers;

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="ss-loading">No receivers found</td></tr>';
                if (countEl) countEl.textContent = '';
                return;
            }

            let html = '';
            list.forEach(function(rx) {
                const name = rx.name || rx.url || 'Unknown';
                const location = rx.location || rx.city || '--';
                const freqRange = SystemStatus._formatFreqRange(rx);
                const users = (rx.users !== undefined && rx.users !== null) ? rx.users : '--';
                const status = rx.status || (rx.active ? 'online' : 'offline');
                const statusClass = (status === 'online' || status === 'active') ? 'online' : 'offline';

                html += '<tr>';
                html += '<td class="ss-rx-name">' + SystemStatus._escapeHtml(name) + '</td>';
                html += '<td>' + SystemStatus._escapeHtml(location) + '</td>';
                html += '<td class="ss-rx-freq">' + SystemStatus._escapeHtml(freqRange) + '</td>';
                html += '<td class="ss-rx-users">' + SystemStatus._escapeHtml(String(users)) + '</td>';
                html += '<td><span class="ss-status-dot ' + statusClass + '"></span>' + status + '</td>';
                html += '</tr>';
            });

            tbody.innerHTML = html;
            if (countEl) {
                countEl.textContent = 'Showing ' + list.length + ' of ' + this._receivers.length + ' receivers';
            }
        },

        _formatFreqRange(rx) {
            if (rx.freq_range) return rx.freq_range;
            if (rx.low_freq && rx.high_freq) {
                return (rx.low_freq / 1000).toFixed(0) + ' - ' + (rx.high_freq / 1000).toFixed(0) + ' kHz';
            }
            if (rx.bands) return rx.bands;
            return '--';
        },

        filterReceivers(query) {
            query = query.trim().toLowerCase();
            if (!query) {
                this._filteredReceivers = [...this._receivers];
            } else {
                this._filteredReceivers = this._receivers.filter(function(rx) {
                    const freqStr = SystemStatus._formatFreqRange(rx).toLowerCase();
                    const nameStr = (rx.name || '').toLowerCase();
                    const locStr = (rx.location || rx.city || '').toLowerCase();
                    return freqStr.includes(query) || nameStr.includes(query) || locStr.includes(query);
                });
            }
            this.renderReceivers();
        },

        async findNearest() {
            let lat = localStorage.getItem('observerLat');
            let lon = localStorage.getItem('observerLon');

            if (window.ObserverLocation && ObserverLocation.isSharedEnabled()) {
                const shared = ObserverLocation.getShared();
                lat = shared.lat;
                lon = shared.lon;
            }

            if (!lat || !lon) {
                if (navigator.geolocation) {
                    try {
                        const pos = await new Promise(function(resolve, reject) {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                        });
                        lat = pos.coords.latitude;
                        lon = pos.coords.longitude;
                    } catch (e) {
                        alert('Set your observer location in Settings to find nearest receivers.');
                        return;
                    }
                } else {
                    alert('Set your observer location in Settings to find nearest receivers.');
                    return;
                }
            }

            try {
                const resp = await fetch('/websdr/receivers/nearest?lat=' + lat + '&lon=' + lon);
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                if (data.receivers && data.receivers.length > 0) {
                    this._filteredReceivers = data.receivers;
                    this.renderReceivers();
                    const countEl = document.getElementById('ssReceiverCount');
                    if (countEl) {
                        countEl.textContent = 'Showing ' + data.receivers.length + ' nearest receivers';
                    }
                }
            } catch (e) {
                console.warn('Failed to find nearest receivers:', e);
            }
        },

        // ------------------------------------------
        // WebSDR Status
        // ------------------------------------------
        async loadWebSDRStatus() {
            const el = document.getElementById('ssWebSDRStatus');
            try {
                const resp = await fetch('/websdr/status');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();
                if (el) {
                    if (data.connected || data.status === 'ok') {
                        el.textContent = 'CONNECTED';
                        el.style.color = 'var(--accent-green)';
                    } else {
                        el.textContent = 'READY';
                        el.style.color = 'var(--accent-cyan)';
                    }
                }
            } catch (e) {
                if (el) {
                    el.textContent = 'OFFLINE';
                    el.style.color = 'var(--accent-red)';
                }
            }
        },

        // ------------------------------------------
        // System Updates
        // ------------------------------------------
        async checkUpdates() {
            const badgeEl = document.getElementById('ssUpdateBadge');
            const latestEl = document.getElementById('ssLatestVersion');
            const updateBtn = document.getElementById('ssUpdateBtn');

            if (badgeEl) {
                badgeEl.textContent = 'Checking...';
                badgeEl.className = 'ss-update-badge checking';
            }

            try {
                const resp = await fetch('/updater/check?force=false');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                if (latestEl) {
                    latestEl.textContent = data.latest_version || '--';
                }

                if (badgeEl) {
                    if (data.update_available) {
                        badgeEl.textContent = 'Update Available';
                        badgeEl.className = 'ss-update-badge update-available';
                        if (updateBtn) updateBtn.style.display = '';
                    } else {
                        badgeEl.textContent = 'Up to Date';
                        badgeEl.className = 'ss-update-badge up-to-date';
                        if (updateBtn) updateBtn.style.display = 'none';
                    }
                }
            } catch (e) {
                if (badgeEl) {
                    badgeEl.textContent = 'Check Failed';
                    badgeEl.className = 'ss-update-badge error';
                }
                console.warn('Failed to check updates:', e);
            }
        },

        async performUpdate() {
            const progressEl = document.getElementById('ssUpdateProgress');
            const progressText = document.getElementById('ssProgressText');
            const progressFill = document.getElementById('ssProgressFill');
            const resultEl = document.getElementById('ssUpdateResult');
            const updateBtn = document.getElementById('ssUpdateBtn');
            const restartBtn = document.getElementById('ssRestartBtn');

            if (progressEl) progressEl.style.display = '';
            if (progressText) progressText.textContent = 'Fetching updates...';
            if (progressFill) progressFill.style.width = '30%';
            if (updateBtn) updateBtn.disabled = true;
            if (resultEl) resultEl.style.display = 'none';

            try {
                if (progressFill) progressFill.style.width = '60%';
                if (progressText) progressText.textContent = 'Applying updates...';

                const resp = await fetch('/updater/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stash_changes: false })
                });

                const data = await resp.json();

                if (progressFill) progressFill.style.width = '100%';

                setTimeout(function() {
                    if (progressEl) progressEl.style.display = 'none';

                    if (data.success && data.updated) {
                        if (resultEl) {
                            resultEl.style.display = '';
                            resultEl.className = 'ss-update-result success';
                            resultEl.innerHTML = '<strong>Update successful!</strong> Restart the application to complete.';
                        }
                        if (restartBtn) restartBtn.style.display = '';
                        if (updateBtn) updateBtn.style.display = 'none';
                    } else if (data.success) {
                        if (resultEl) {
                            resultEl.style.display = '';
                            resultEl.className = 'ss-update-result info';
                            resultEl.textContent = data.message || 'Already up to date.';
                        }
                    } else {
                        if (resultEl) {
                            resultEl.style.display = '';
                            resultEl.className = 'ss-update-result error';
                            resultEl.textContent = data.message || data.error || 'Update failed.';
                        }
                        if (updateBtn) updateBtn.disabled = false;
                    }
                }, 500);
            } catch (e) {
                if (progressEl) progressEl.style.display = 'none';
                if (resultEl) {
                    resultEl.style.display = '';
                    resultEl.className = 'ss-update-result error';
                    resultEl.textContent = 'Error: ' + e.message;
                }
                if (updateBtn) updateBtn.disabled = false;
            }
        },

        async restartApp() {
            if (!confirm('Restart the application? This will briefly disconnect all users.')) return;

            const restartBtn = document.getElementById('ssRestartBtn');
            if (restartBtn) {
                restartBtn.disabled = true;
                restartBtn.textContent = 'Restarting...';
            }

            try {
                await fetch('/updater/restart', { method: 'POST' });
                setTimeout(function() { window.location.reload(); }, 5000);
            } catch (e) {
                setTimeout(function() { window.location.reload(); }, 5000);
            }
        },

        // ------------------------------------------
        // System Info & Uptime
        // ------------------------------------------
        startUptimeCounter() {
            var self = this;
            var el = document.getElementById('ssUptime');
            if (!el) return;

            function updateUptime() {
                var elapsed = Date.now() - self._startTime;
                var totalSec = Math.floor(elapsed / 1000);
                var hours = Math.floor(totalSec / 3600);
                var minutes = Math.floor((totalSec % 3600) / 60);
                var seconds = totalSec % 60;

                el.textContent = String(hours).padStart(2, '0') + ':' +
                                 String(minutes).padStart(2, '0') + ':' +
                                 String(seconds).padStart(2, '0');
            }

            fetch('/updater/status')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.uptime_seconds) {
                        self._startTime = Date.now() - (data.uptime_seconds * 1000);
                    }
                })
                .catch(function() {});

            setInterval(updateUptime, 1000);
            updateUptime();
        },

        // ------------------------------------------
        // Utilities
        // ------------------------------------------
        updateLastRefresh() {
            var el = document.getElementById('ssLastRefresh');
            if (el) {
                var now = new Date();
                el.textContent = 'LAST REFRESH: ' + now.toISOString().slice(11, 19) + ' UTC';
            }
        },

        refreshAll() {
            this.loadOfflineSettings();
            this.checkAssets();
            this.loadReceivers();
            this.checkUpdates();
            this.loadWebSDRStatus();
            this.updateLastRefresh();
        },

        _showReloadPrompt() {
            var prompt = document.getElementById('ssReloadPrompt');
            if (prompt) return;

            prompt = document.createElement('div');
            prompt.id = 'ssReloadPrompt';
            prompt.className = 'ss-reload-prompt';
            prompt.innerHTML = '<span>Reload to apply changes</span>' +
                '<button class="ss-btn ss-btn-sm ss-btn-primary" onclick="location.reload()">Reload</button>' +
                '<button class="ss-btn ss-btn-sm" onclick="this.parentElement.remove()">&times;</button>';
            document.body.appendChild(prompt);
        },

        _escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    };

    // ------------------------------------------
    // UTC Clock
    // ------------------------------------------
    function updateClock() {
        var now = new Date();
        var el = document.getElementById('utcTime');
        if (el) el.textContent = now.toISOString().substring(11, 19) + ' UTC';
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ------------------------------------------
    // Initialize on DOM ready
    // ------------------------------------------
    document.addEventListener('DOMContentLoaded', function() {
        SystemStatus.init();
    });
    </script>
</body>
</html>
